@()

@import helper._
@import org.hadatac.console.views.html._

@main("Simple Faceted Search") {
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
	<script type="text/javascript" src="/hadatac/assets/javascripts/measurement.js"></script>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-3 sidebar">
				<div id="legend">
					<legend>Facet search</legend>
				</div>
				<div width="100%" style="background-color:#dddddd">
					<label class="col-md-offset-1 control-label">Studies</label>
				</div>
				<div id="treeStudyBox" style="width:100%; height:150px; background-color:#f5f5f5; border :1px solid Silver; overflow:auto;"></div>
				
				<div width="100%" style="background-color:#dddddd">
					<label class="col-md-offset-1 control-label">Entities and Characteristics</label>
				</div>
				<div id="treeEntityCharacteristicBox" style="width:100%; height:150px; background-color:#f5f5f5; border :1px solid Silver; overflow:auto;"></div>
				
				<div width="100%" style="background-color:#dddddd">
					<label class="col-md-offset-1 control-label">Units</label>
				</div>
				<div id="treeUnitBox" style="width:100%; height:150px; background-color:#f5f5f5; border :1px solid Silver; overflow:auto;"></div>
				
				<div width="100%" style="background-color:#dddddd">
					<label class="col-md-offset-1 control-label">Platforms and Instruments</label>
				</div>
				<div id="treePlatformInstrumentBox" style="width:100%; height:150px; background-color:#f5f5f5; border :1px solid Silver; overflow:auto;"></div>
				
				<center>
					<button type="button" class="btn btn-primary" onClick="clearSearch();">Clear Search</button>
				</center>
			</div>
			<div class="col-md-5 main">
				<div id="legend">
					<legend>Measurements</legend>
				</div>
				<div class="row placeholders"></div>
				<div class="row placeholders"></div>
				<div>
					<div id="acquisition" class="tab-pane">
						@table_acquisition()
					</div>
				</div>
				<div class="container">
					<ul class="pagination">
						
					</ul>
				</div>
			</div>
			<div class="col-md-4">
				<div class="row">
					<div id="legend">
						<legend>Measurement details</legend>
					</div>
					<div class="tab-pane">
						@measurement_details()
					</div>
				</div>
				<div class="row">
					<div id="legend">
						<legend>Metadata details</legend>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<script type="text/javascript">
	var treeS = new dhtmlXTreeObject("treeStudyBox","100%","100%",0);
	var treeEC = new dhtmlXTreeObject("treeEntityCharacteristicBox","100%","100%",0);
	var treeU = new dhtmlXTreeObject("treeUnitBox","100%","100%",0);
	var treePI = new dhtmlXTreeObject("treePlatformInstrumentBox","100%","100%",0);
	var docs;
	var total_docs;
	
	on_data = function(data) {
		//var json = JSON.parse(query_res.replace(/&quot;/g, '\"')).documents;
		//var jsonFacet = JSON.parse(facet_res.replace(/&quot;/g, '\"')).documents;
		str = JSON.stringify(data.response);
		alert(str);
        docs = data.response.docs;
        total_docs = 'Found ' + docs.length + ' results';
        loadTree(treeS, JSON.parse(parseSolrFacetPivotToTree("study_uri", docs)));
        loadTree(treeEC, JSON.parse(parseSolrFacetPivotToTree("entity,characteristic", docs)));
        loadTree(treeU, JSON.parse(parseSolrFacetFieldToTree("unit", json)));
        loadTree(treePI, JSON.parse(parseSolrFacetPivotToTree("platform_name,instrument_model", docs)));
        updatePage(docs);
    }
	
	onload = function() {
		var url = location.protocol + '//' + location.host + '/hadatac/acquisitions/querysearch';
		alert(url);
		$.getJSON(url, 
				 { start: "0", rows: "100", facets: ""},
				 on_data);
	
		if (!document.getElementsByTagName || !document.createTextNode) return;
		var rows = document.getElementById('measurementsTable').rows;
		for (i = 0; i < rows.length; i++) {
			rows[i].onmouseover = function() {
				var row = this.rowIndex - 1;
				document.getElementById('detail_uri').innerHTML = json.documents[row]['uri'];
				document.getElementById('detail_timestamp').innerHTML = json.documents[row]['timestamp'];
				document.getElementById('detail_value').innerHTML = json.documents[row]['value'];
				document.getElementById('detail_entity').innerHTML = json.documents[row]['entity'];
				document.getElementById('detail_entity_uri').innerHTML = json.documents[row]['entityUri'];
				document.getElementById('detail_characteristic').innerHTML = json.documents[row]['characteristic'];
				document.getElementById('detail_characteristic_uri').innerHTML = json.documents[row]['characteristicUri'];
				document.getElementById('detail_unit').innerHTML = json.documents[row]['unit'];
				document.getElementById('detail_unit_uri').innerHTML = json.documents[row]['unitUri'];
				document.getElementById('detail_instrument_model').innerHTML = json.documents[row]['instrumentModel'];
				document.getElementById('detail_instrument_uri').innerHTML = json.documents[row]['instrumentUri'];
				document.getElementById('detail_platform_name').innerHTML = json.documents[row]['platformName'];
				document.getElementById('detail_platform_uri').innerHTML = json.documents[row]['platformUri'];
			}
		}
		updatePage(docs);
	}
		
	function clearSearch(){
		var url = location.protocol + '//' + location.host + location.pathname;
		window.location.href = encodeURI(url);
	}
	function loadTree(tree, data) {
		tree.enableCheckBoxes(true, true);
		tree.enableThreeStateCheckboxes(true);
		tree.setImagePath("@controllers.routes.Assets.versioned("lib/dhtmlx/imgs/dhxtree_skyblue/")");
		tree.setDataMode("json");
		tree.attachEvent("onCheck",function(id) {
			jsonFacet['facetsAnd'][tree.getUserData(id, 'field')] = tree.getUserData(id, 'value');
			var url = location.protocol + '//' + location.host + location.pathname;
			url += '?facets=' + JSON.stringify(jsonFacet);
			window.location.href = encodeURI(url);
			return true;
		});
		tree.parse(data, "json");
		tree.openAllItems(0);
	}
	</script>
}